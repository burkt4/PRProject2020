"""
In this file, we try to optimize the number of neuron
We try the value 10, 25, 40, 55, 70, 85, 100, 115
"""

import csv
import numpy as np
import torch
import torch.nn as nn
from torch.utils.data import DataLoader
from torchvision.transforms import ToTensor, Compose
import utils

# First, we build our training and validation set
# We will put about 70% of the data in the training set and 30% in the validation set
training_set = []
labels_training = []
validation_set = []
labels_validation = []

with open('mnist_train.csv', 'r') as f:
    reader = csv.reader(f)
    line_number = 0
    for line in reader:
        if line_number < 42000:
            x = np.array(line[0])
            labels_training.append(x.astype(np.float))
            y = np.array(line[1:])
            training_set.append(y.astype(np.float))
        else:
            x = np.array(line[0])
            labels_validation.append(x.astype(np.float))
            y = np.array(line[1:])
            validation_set.append(y.astype(np.float))

        line_number = line_number+1

transforms = Compose([
    ToTensor(),
])
train_set = utils.OurDataset(training_set, labels_training, transforms)
val_set = utils.OurDataset(validation_set, labels_validation, transforms)

dataloader_train_set = DataLoader(train_set, batch_size=1, shuffle=True)
dataloader_val = DataLoader(val_set, batch_size=1, shuffle=True)

# Then, we define the different parameters of our model and our learning approach:
loss_fn = nn.CrossEntropyLoss()
lr = 0.01
n_epoch = 15

# We try 10, 25, 40, 55, 70, 85, 100, 115
neuron_number = 115

# Now, we can build our model :
model = utils.MLP(neuron_number)
# We choose the stochastic gradient descent as optimizer :
optimizer = torch.optim.SGD(model.parameters(), lr)


# We train and compute the accuracy of our model :
tr_accuracy, tr_loss, val_accuracy, val_loss, _ = utils.train_model(model, dataloader_train_set, dataloader_val,
                                                                 n_epoch, optimizer, loss_fn)
# Finally, we print the results :
print("tr_loss :")
print(tr_loss)
print("val_loss :")
print(val_loss)

print("tr_accuracy : ")
print(tr_accuracy)
print("train accuracy mean :")
print(np.mean(tr_accuracy))

print("val_accuracy :")
print(val_accuracy)
print("validation accuracy mean :")
print(np.mean(val_accuracy))


""" 
Output : 

neuron_number = 10 :
tr_loss :
[0.4054130231023427, 0.2915681162696631, 0.26810886462029826, 0.2525767680090055, 0.2443553926276697, 0.242900648048635, 0.23387989029153716, 0.2314473144019427, 0.2265601295167071, 0.2231959234573939, 0.22172649155402044, 0.21965431414989858, 0.2166976525954043, 0.2128668087517701, 0.21305499944079978]
val_loss :
[0.3071689305498804, 0.28831065031088987, 0.3031864631480542, 0.2904441498942156, 0.28470833403451795, 0.2680062132783503, 0.26593031471793227, 0.26964850867874124, 0.24660481084073294, 0.2682580102876446, 0.2737155648317643, 0.25864409589982157, 0.289577189633313, 0.27425839276762276, 0.26098272297495795]
tr_accuracy : 
[0.8805238095238095, 0.9157380952380952, 0.9224285714285714, 0.9264761904761905, 0.9283095238095238, 0.9281904761904762, 0.930404761904762, 0.9310714285714285, 0.932952380952381, 0.9329047619047619, 0.9341190476190476, 0.9343333333333333, 0.9350238095238095, 0.9348809523809524, 0.9361190476190476]
train accuracy mean :
0.9268984126984126
val_accuracy :
[0.9101666666666667, 0.9184444444444444, 0.9128333333333334, 0.9198333333333333, 0.919, 0.9252777777777778, 0.9253888888888889, 0.9233888888888889, 0.9331111111111111, 0.9268888888888889, 0.9235, 0.9280555555555555, 0.9237777777777778, 0.9280555555555555, 0.9265555555555556]
validation accuracy mean :
0.922951851851852

neuron_number = 25 :
tr_loss :
[0.3264448131328347, 0.18767850021206686, 0.1555638350878417, 0.13558504332272922, 0.12461761989568787, 0.11490320630981904, 0.10555769075208768, 0.09811499506401833, 0.09548470046785554, 0.09030653668765577, 0.08629267929217967, 0.08225731726796695, 0.0779110095581977, 0.07348010492798633, 0.07179938321020554]
val_loss :
[0.23043828617991344, 0.1802147392610539, 0.21107113214147993, 0.1616757499827023, 0.16273556460580665, 0.14177524510430667, 0.15532767378576567, 0.1800523171429615, 0.1784220274384562, 0.1657685812987878, 0.18277173075696626, 0.16966973874659466, 0.17312663873318607, 0.1703595537183529, 0.1902458695523729]
tr_accuracy : 
[0.9037857142857143, 0.9439761904761905, 0.9522857142857143, 0.9599761904761904, 0.9626666666666667, 0.9653809523809523, 0.9672857142857143, 0.9693571428571428, 0.9702380952380952, 0.9714285714285714, 0.9728095238095238, 0.9742857142857143, 0.9752857142857143, 0.9768809523809524, 0.9767619047619047]
train accuracy mean :
0.9628269841269841
val_accuracy :
[0.9314444444444444, 0.9465, 0.9404444444444444, 0.9526111111111111, 0.9549444444444445, 0.9598333333333333, 0.9560555555555555, 0.9502222222222222, 0.9553888888888888, 0.9567777777777777, 0.9541111111111111, 0.9565, 0.9583333333333334, 0.9581111111111111, 0.9571666666666667]
validation accuracy mean :
0.952562962962963

neuron_number = 40
tr_loss :
[0.30865520285735143, 0.16298346516884177, 0.12511663367344758, 0.1042595343228932, 0.0906574805094972, 0.0791758319105166, 0.07276594247111354, 0.06370861961123447, 0.058953407086415166, 0.055106277299773195, 0.05141487502214079, 0.045523072447374274, 0.0420889724284799, 0.03917764454679323, 0.03526276582968129]
val_loss :
[0.1970509705218969, 0.22650629491332314, 0.14412240165596835, 0.13619200038627322, 0.13372291278813475, 0.1433873808568181, 0.14626153809764467, 0.12862702913590673, 0.16838105183921587, 0.15062421853717936, 0.15656857315414424, 0.1413688268914355, 0.1389696919540102, 0.15362658704270285, 0.17478724768327497]
tr_accuracy : 
[0.9078571428571428, 0.9502142857142857, 0.9623571428571429, 0.9685952380952381, 0.9715238095238096, 0.9758571428571429, 0.9772857142857143, 0.9790714285714286, 0.9812619047619048, 0.9829761904761904, 0.983547619047619, 0.9851428571428571, 0.9858809523809524, 0.987, 0.9884285714285714]
train accuracy mean :
0.9724666666666667
val_accuracy :
[0.9413333333333334, 0.9294444444444444, 0.9606666666666667, 0.9603333333333334, 0.9632777777777778, 0.9625555555555556, 0.9592222222222222, 0.9658888888888889, 0.9573888888888888, 0.9612777777777778, 0.9621666666666666, 0.9665, 0.9665, 0.9662222222222222, 0.9617777777777777]
validation accuracy mean :
0.9589703703703704


neuron_number = 55
tr_loss :
[0.2960457038998837, 0.14276789508521154, 0.1091918538013978, 0.08656355449049882, 0.07316026132459155, 0.06352915903185447, 0.052887445602894094, 0.04602875299461783, 0.03845156184019699, 0.03244331534756282, 0.029050430192345027, 0.023514703251564874, 0.022169744573103674, 0.01776602876736409, 0.013740607164565745]
val_loss :
[0.17068230673361973, 0.15157011110819502, 0.1229768819023048, 0.1289449526117919, 0.11780089100197415, 0.1291757313813175, 0.12656419159144902, 0.1336312505333549, 0.13293395076498482, 0.12975364820162905, 0.13494101331428177, 0.15511081843935975, 0.1353572428613136, 0.14584928527168753, 0.15418362355539145]
tr_accuracy : 
[0.9106428571428572, 0.9568809523809524, 0.9661190476190477, 0.9736904761904762, 0.9767857142857143, 0.9796666666666667, 0.9830714285714286, 0.984547619047619, 0.9871428571428571, 0.9895, 0.9906190476190476, 0.9922619047619048, 0.9928333333333333, 0.994452380952381, 0.9958095238095238]
train accuracy mean :
0.978268253968254
val_accuracy :
[0.9490555555555555, 0.9559444444444445, 0.9628888888888889, 0.9626111111111111, 0.9671666666666666, 0.9659444444444445, 0.9674444444444444, 0.965, 0.9658888888888889, 0.9683888888888889, 0.9682222222222222, 0.9646111111111111, 0.9693333333333334, 0.9682222222222222, 0.9677222222222223]
validation accuracy mean :
0.964562962962963

number_neuron = 70
tr_loss :
[0.29564394569443914, 0.1361937412975737, 0.09839590569975501, 0.07773810654026737, 0.06333216992071193, 0.05068946820085986, 0.04076147653576146, 0.03408198143925922, 0.027972474042515266, 0.02475689216020588, 0.01963259796137559, 0.01540081399901524, 0.01059915190689107, 0.008029655130237288, 0.006346939954019327]
val_loss :
[0.17085596715469478, 0.13137865689107478, 0.12244755137650537, 0.1224212100798701, 0.12502634127381593, 0.1088263588209528, 0.10847834271682283, 0.11643687618411117, 0.11865803764926922, 0.12129521376976181, 0.11641735781107153, 0.1182343509942832, 0.11379482040471324, 0.130267274475072, 0.1206439047138976]
tr_accuracy : 
[0.9125238095238095, 0.9598095238095238, 0.9700952380952381, 0.9748095238095238, 0.9803333333333333, 0.9842380952380952, 0.9872619047619048, 0.9886428571428572, 0.9913571428571428, 0.9921666666666666, 0.9937380952380952, 0.9953809523809524, 0.9971428571428571, 0.998, 0.9987857142857143]
train accuracy mean :
0.9816190476190475
val_accuracy :
[0.9490555555555555, 0.9615555555555556, 0.9641111111111111, 0.9631111111111111, 0.9657777777777777, 0.9695555555555555, 0.9703888888888889, 0.9692777777777778, 0.9691666666666666, 0.9682777777777778, 0.971, 0.9723888888888889, 0.9734444444444444, 0.9700555555555556, 0.9728333333333333]
validation accuracy mean :
0.9673333333333333

neuron_number = 85
tr_loss :
[0.28156052824941974, 0.1238369311124621, 0.08876838972857413, 0.07041906550282538, 0.05612077805582166, 0.04454592009425271, 0.037146148031142995, 0.02962387983789322, 0.025189526439724084, 0.018228496050152587, 0.014773118736356054, 0.011783007460636074, 0.0073701760549193555, 0.00538034108999064, 0.004314929705818804]
val_loss :
[0.16129462407335945, 0.12513987755816702, 0.11670450822413866, 0.12127472274003218, 0.1009360734693276, 0.12633186754531103, 0.1078372076804389, 0.11901804956711959, 0.10581281189338342, 0.11178743972439724, 0.11903275638640369, 0.11051922338829674, 0.10675056585854083, 0.11530080959006267, 0.11412908459464681]
tr_accuracy : 
[0.9156666666666666, 0.9622142857142857, 0.9729047619047619, 0.9782619047619048, 0.9822142857142857, 0.9860952380952381, 0.9881428571428571, 0.9903809523809524, 0.9918333333333333, 0.994452380952381, 0.9954285714285714, 0.9967380952380952, 0.9982619047619048, 0.9991190476190476, 0.9993333333333333]
train accuracy mean :
0.9834031746031745
val_accuracy :
[0.9514444444444444, 0.9624444444444444, 0.9648333333333333, 0.9656111111111111, 0.9723333333333334, 0.9641111111111111, 0.9707777777777777, 0.9691111111111111, 0.9727222222222223, 0.9742777777777778, 0.9719444444444445, 0.9731666666666666, 0.9767777777777777, 0.9745555555555555, 0.9746111111111111]
validation accuracy mean :
0.9692481481481481

neuron_number = 100
tr_loss :
[0.27961358611917814, 0.12194768748649935, 0.08571316346534875, 0.06431750012241226, 0.04933044811715542, 0.03740552891198594, 0.030182261726242263, 0.023005090507609467, 0.019270936873942792, 0.01265271011013264, 0.00957003595353894, 0.006863404770194328, 0.004616140225677561, 0.0027527676973242124, 0.0018887985439228654]
val_loss :
[0.1619569106120054, 0.13742120812377487, 0.11024931688566804, 0.11354152979134927, 0.12030937856634064, 0.10773718880375317, 0.1026069018602658, 0.09664072882921745, 0.104615032631999, 0.09869314079516156, 0.10676684472109724, 0.1140623365862435, 0.10455709934697228, 0.10384752088318955, 0.10549614466184365]
tr_accuracy : 
[0.9162619047619047, 0.9631904761904762, 0.9736904761904762, 0.9795238095238096, 0.9843095238095239, 0.9883571428571428, 0.9900952380952381, 0.9927142857142857, 0.9942142857142857, 0.9966428571428572, 0.9974761904761905, 0.9985, 0.9992142857142857, 0.9998095238095238, 0.9999285714285714]
train accuracy mean :
0.9849285714285715
val_accuracy :
[0.9525555555555556, 0.9581666666666667, 0.967, 0.9666111111111111, 0.967, 0.9713333333333334, 0.9728333333333333, 0.9748333333333333, 0.9741111111111111, 0.9747222222222223, 0.9756666666666667, 0.9734444444444444, 0.9762222222222222, 0.9767777777777777, 0.9772777777777778]
validation accuracy mean :
0.9705703703703705


neuron_number = 115
tr_accuracy : 
[0.9154523809523809, 0.963, 0.9743333333333334, 0.9798571428571429, 0.984904761904762, 0.9883333333333333, 0.9904285714285714, 0.9932857142857143, 0.9954047619047619, 0.9966428571428572, 0.9985238095238095, 0.9991666666666666, 0.9995714285714286, 0.9998809523809524, 0.9998809523809524]
train accuracy mean :
0.9852444444444445
val_accuracy :
[0.9476666666666667, 0.9547777777777777, 0.965, 0.9714444444444444, 0.9681111111111111, 0.9696111111111111, 0.9696666666666667, 0.9747222222222223, 0.9751111111111112, 0.9768333333333333, 0.9767222222222223, 0.9767222222222223, 0.9771666666666666, 0.9758333333333333, 0.9776111111111111]
validation accuracy mean :
0.9704666666666667

"""